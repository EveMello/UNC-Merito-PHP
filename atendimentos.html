
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Atendimentos - Sistema de ProntuÃ¡rio MÃ©dico</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="css/styles.css" rel="stylesheet" />
  <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
  <style>
    .actions{display:flex;gap:.5rem}
    .card-body{padding:2rem}
    table{margin-top:1rem;width:100%}
    table th{background:#f8f9fa;text-align:center;padding:.75rem}
    table td{background:#fff;text-align:center;padding:.75rem;border:1px solid #dee2e6}
    .anexo-link{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px;display:inline-block}
  </style>
</head>
<body class="sb-nav-fixed">
  <!-- NAVBAR -->
  <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
    <a class="navbar-brand ps-3" href="index.php">ProntuÃ¡rio MÃ©dico</a>
    <button class="btn btn-link btn-sm order-1 order-lg-0 me-4 me-lg-0" id="sidebarToggle"><i class="fas fa-bars"></i></button>
    <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown"><i class="fas fa-user fa-fw"></i></a>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="#">ConfiguraÃ§Ãµes</a></li>
          <li><a class="dropdown-item" href="#">Sair</a></li>
        </ul>
      </li>
    </ul>
  </nav>

  <div id="layoutSidenav">
    <!-- SIDEBAR -->
    <div id="layoutSidenav_nav">
      <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
        <div class="sb-sidenav-menu">
          <div class="nav">
            <div class="sb-sidenav-menu-heading">Principal</div>
            <a class="nav-link" href="index.html"><div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
                Dashboard
              </a>
              <div class="sb-sidenav-menu-heading">GestÃ£o</div>
              <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapsePatients" aria-expanded="false" aria-controls="collapsePatients">
                <div class="sb-nav-link-icon"><i class="fas fa-user-injured"></i></div>
                Pacientes
                <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
              </a>
              <div class="collapse" id="collapsePatients" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion">
                <nav class="sb-sidenav-menu-nested nav">
                  <a class="nav-link" href="pacientes.html">Lista de Pacientes</a>
                </nav>
              </div>
              <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseDoctors" aria-expanded="false" aria-controls="collapseDoctors">
                <div class="sb-nav-link-icon"><i class="fas fa-user-md"></i></div>
                MÃ©dicos
                <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
              </a>
              <div class="collapse" id="collapseDoctors" aria-labelledby="headingTwo" data-bs-parent="#sidenavAccordion">
                <nav class="sb-sidenav-menu-nested nav">
                  <a class="nav-link" href="medicos.html">Lista de MÃ©dicos</a>
                </nav>
              </div>
              <a class="nav-link" href="medicamentos.html">
                <div class="sb-nav-link-icon"><i class="fas fa-pills"></i></div>
                Medicamentos
              </a>
             <a class="nav-link active" href="atendimentos.html"><div class="sb-nav-link-icon"><i class="fas fa-notes-medical"></i></div>Atendimentos</a>
            <!-- <a class="nav-link" href="consentimentos.php"><div class="sb-nav-link-icon"><i class="fas fa-file-signature"></i></div>Consentimentos</a> -->
            </div>
        </div>
        <div class="sb-sidenav-footer">
          <div class="small">Logado como:</div>Administrador
        </div>
      </nav>
    </div>

    <!-- CONTEÃšDO -->
    <div id="layoutSidenav_content">
      <main>
        <div class="container-fluid px-4">
          <h1 class="mt-4">Atendimentos</h1>
          <ol class="breadcrumb mb-4">
            <li class="breadcrumb-item"><a href="index.php">Dashboard</a></li>
            <li class="breadcrumb-item active">Atendimentos</li>
          </ol>

          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <div><i class="fas fa-table me-1"></i> Lista de Atendimentos</div>
              <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#atendimentoModal" id="btnNovo">Novo Atendimento</button>
            </div>
            <div class="card-body">
              <div id="alertContainer"></div>
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Paciente</th>
                    <th>Profissional</th>
                    <th>Tipo</th>
                    <th>Status</th>
                    <th>Data</th>
                    <th>Anexo</th>
                    <th>AÃ§Ãµes</th>
                  </tr>
                </thead>
                <tbody id="tbodyAtendimentos"></tbody>
              </table>
            </div>
          </div>
        </div>
      </main>

      <!-- MODAL CRIAR/EDITAR -->
      <div class="modal fade" id="atendimentoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg"><div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Novo Atendimento</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="formAtendimento">
              <input type="hidden" id="at_id" />
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Paciente</label>
                  <div class="input-group">
                    <select id="at_paciente" class="form-select" required></select>
                    <button type="button" class="btn btn-outline-secondary mic-select" data-target="at_paciente">ðŸŽ¤</button>
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Profissional</label>
                  <div class="input-group">
                    <select id="at_profissional" class="form-select" required></select>
                    <button type="button" class="btn btn-outline-secondary mic-select" data-target="at_profissional">ðŸŽ¤</button>
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Tipo</label>
                  <div class="input-group">
                    <select id="at_tipo" class="form-select">
                      <option>Consulta</option>
                      <option>UrgÃªncia</option>
                      <option>Retorno</option>
                      <option>Outro</option>
                    </select>
                    <button type="button" class="btn btn-outline-secondary mic-select" data-target="at_tipo">ðŸŽ¤</button>
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Status</label>
                  <div class="input-group">
                    <select id="at_status" class="form-select">
                      <option>Em Andamento</option>
                      <option>Realizado</option>
                      <option>Pendente</option>
                      <option>Cancelado</option>
                    </select>
                    <button type="button" class="btn btn-outline-secondary mic-select" data-target="at_status">ðŸŽ¤</button>
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Data</label>
                  <input type="date" id="at_data" class="form-control">
                </div>
                <div class="col-md-6">
                  <label class="form-label">DiagnÃ³stico</label>
                  <div class="input-group">
                    <input type="text" id="at_diagnostico" class="form-control">
                    <button type="button" class="btn btn-outline-secondary mic-btn" data-target="at_diagnostico">
                      ðŸŽ¤
                    </button>
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">CID</label>
                  <div class="input-group">
                    <input type="text" id="at_cid" class="form-control">
                    <button type="button" class="btn btn-outline-secondary mic-btn" data-target="at_cid">
                      ðŸŽ¤
                    </button>
                  </div>
                </div>

                <div class="col-12">
                  <label class="form-label">ObservaÃ§Ãµes</label>
                  <div class="input-group">
                    <textarea id="at_obs" class="form-control" rows="2"></textarea>
                    <button type="button" class="btn btn-outline-secondary mic-btn" data-target="at_obs">
                      ðŸŽ¤
                    </button>
                  </div>
                </div>
                <div class="col-12">
                  <label class="form-label">Anexo (pdf, jpg, png, doc, docx)</label>
                  <input type="file" id="at_anexo" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                  <div class="form-text">Opcional. MÃ¡x ~10MB (dependente do PHP).</div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-primary" id="btnSalvar">Salvar</button>
          </div>
        </div></div>
      </div>

      <!-- MODAL DETALHES -->
      <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg"><div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Detalhes do Atendimento</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body" id="detailsContent"></div>
          <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button></div>
        </div></div>
      </div>

      <footer class="py-4 bg-light mt-auto">
        <div class="container-fluid px-4">
          <div class="d-flex align-items-center justify-content-between small">
            <div class="text-muted">Copyright &copy; MÃ©rito Health</div>
          </div>
        </div>
      </footer>
    </div>
  </div>

  <!-- MODAL RECEITAS -->
   <div class="modal fade" id="modalReceita" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="modalLabel">Dados da Receita</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                  <form id="rxForm">
                      <div class="mb-3">
                          <label class="form-label">Paciente</label>
                          <select id="paciente_id" class="form-select" required></select>
                      </div>
                      <div class="mb-3">
                          <label class="form-label">MÃ©dico</label>
                          <select id="medico_id" class="form-select" required></select>
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                  <button type="button" class="btn btn-primary" onclick="salvarReceita()">Salvar Receita</button>
              </div>
          </div>
      </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API = 'api/atendimentos.php';
    const tbody = document.getElementById('tbodyAtendimentos');
    const alertContainer = document.getElementById('alertContainer');
    const modalEl = document.getElementById('atendimentoModal');
    const modal = () => bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);

    function showAlert(msg, type = 'success') {
      const oldAlert = document.getElementById('floatingAlert');
      if (oldAlert) oldAlert.remove();

      // Cria o alerta flutuante
      const alertDiv = document.createElement('div');
      alertDiv.id = 'floatingAlert';
      alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
      alertDiv.role = 'alert';
      alertDiv.style.position = 'fixed';
      alertDiv.style.top = '20px';
      alertDiv.style.right = '20px';
      alertDiv.style.zIndex = '9999';
      alertDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
      alertDiv.innerHTML = `
        ${msg}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;

      document.body.appendChild(alertDiv);

      // Remove apÃ³s 3 segundos
      setTimeout(() => {
        const al = bootstrap.Alert.getOrCreateInstance(alertDiv);
        al.close();
      }, 3000);
    }


    //Carregar os pacientes no Atendimento
    async function loadPacientes(){
      const sel = document.getElementById('at_paciente');
      sel.innerHTML = '<option value="">Carregando...</option>';
      try {
        const res = await fetch('api/pacientes.php');
        const data = await res.json();
        sel.innerHTML = '<option value="">Selecione...</option>';
        data.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.nome;
          sel.appendChild(opt);
        });
      } catch(e){
        sel.innerHTML = '<option value="">Erro ao carregar</option>';
      }
    }

    //Carregar os mÃ©dicos no Atendimento:
    async function loadMedicos(){
      const sel = document.getElementById('at_profissional');
      sel.innerHTML = '<option value="">Carregando...</option>';
      try {
        const res = await fetch('api/medicos.php');
        const data = await res.json();
        sel.innerHTML = '<option value="">Selecione...</option>';
        data.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.nome;
          sel.appendChild(opt);
        });
      } catch(e){
        sel.innerHTML = '<option value="">Erro ao carregar</option>';
      }
    }

    async function loadRows(){
      tbody.innerHTML = '<tr><td colspan="7">Carregando...</td></tr>';
      try{
        const res = await fetch(API);
        const data = await res.json();
        if(!Array.isArray(data)){ throw new Error('Resposta inesperada.'); }
        if(data.length===0){ tbody.innerHTML = '<tr><td colspan="7">Nenhum atendimento cadastrado.</td></tr>'; return; }
        tbody.innerHTML = '';
        data.forEach(a=>{
          const tr = document.createElement('tr');
          tr.dataset.id = a.id;
          tr.innerHTML = `
            <td>${a.paciente}</td>
            <td>${a.profissional}</td>
            <td>${a.tipo}</td>
            <td>${a.status}</td>
            <td>${a.data_atendimento}</td>
            <td>${a.anexo ? `<a class="anexo-link" href="${a.anexo}" target="_blank" title="Abrir anexo">${a.anexo.split('/').pop()}</a>` : '-'}</td>
            <td class="actions justify-content-center">
              <button class="btn btn-sm btn-info" data-action="detalhes">Detalhes</button>
              <button class="btn btn-sm btn-warning" data-action="editar">Editar</button>
              <button class="btn btn-sm btn-danger" data-action="excluir">Excluir</button>
              <a href="receita.html?atendimento_id=${a.id}" class="btn btn-sm btn-success">Receita</a>
            </td>`;
          tbody.appendChild(tr);
        });
      }catch(e){
        tbody.innerHTML = `<tr><td colspan="7" class="text-danger">Erro: ${e.message}</td></tr>`;
      }
    }

    // Novo
    document.getElementById('btnNovo').addEventListener('click', ()=>{
      document.getElementById('modalTitle').innerText = 'Novo Atendimento';
      document.getElementById('formAtendimento').reset();
      document.getElementById('at_id').value = '';
    });

    // -------------------- DITADO POR VOZ CAMPOS DE TEXTO--------------------
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;

    if (SpeechRecognition) {
      recognition = new SpeechRecognition();
      recognition.lang = 'pt-BR';
      recognition.continuous = false;
      recognition.interimResults = false;

      document.querySelectorAll('.mic-btn').forEach(btn => {
        btn.disabled = false; // Garante habilitado quando suportado

        btn.addEventListener('click', () => {
          const targetId = btn.getAttribute('data-target');
          const field = document.getElementById(targetId);

          field.focus();
          recognition.start();

          recognition.onresult = (event) => {
            field.value = event.results[0][0].transcript;
          };
        });
      });

      recognition.onerror = () => alert('Erro ao capturar Ã¡udio. Verifique se o microfone estÃ¡ liberado!');
    }
    else {
      // Se nÃ£o tiver suporte, apenas desativa os botÃµes de microfone
      document.querySelectorAll('.mic-btn').forEach(btn => {
        btn.disabled = true;
        btn.title = "Reconhecimento de voz nÃ£o suportado neste navegador"; // Dica ao passar o mouse
      });
    }

    // -------------------- DITADO POR VOZ CAMPOS DE SELEÃ‡ÃƒO--------------------
    if (SpeechRecognition) {

      const normalize = str => str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

      document.querySelectorAll('.mic-select').forEach(btn => {
        btn.disabled = false;

        btn.addEventListener('click', () => {
          const selectId = btn.getAttribute('data-target');
          const selectEl = document.getElementById(selectId);

          recognition.start();

          recognition.onresult = (event) => {
            const spoken = normalize(event.results[0][0].transcript.trim());
            let matched = false;

            for (let option of selectEl.options) {
              const optNorm = normalize(option.textContent);

              // CorrespondÃªncia flexÃ­vel: se parte da frase falada estiver na opÃ§Ã£o ou vice-versa
              if (spoken.includes(optNorm) || optNorm.includes(spoken)) {
                selectEl.value = option.value;
                matched = true;
                break;
              }
            }

            if (!matched) {
              alert(`NÃ£o encontrei uma opÃ§Ã£o correspondente para: "${spoken}"`);
            }
          };
        });
      });

    } else {
      document.querySelectorAll('.mic-select').forEach(btn => {
        btn.disabled = true;
        btn.title = "Reconhecimento de voz nÃ£o suportado neste navegador";
      });
    }



    // Salvar (POST/PUT)
    document.getElementById('btnSalvar').addEventListener('click', async ()=>{
      const id  = document.getElementById('at_id').value.trim();
      const pac = document.getElementById('at_paciente').value.trim();
      const pro = document.getElementById('at_profissional').value.trim();
      const tip = document.getElementById('at_tipo').value.trim();
      const sta = document.getElementById('at_status').value.trim();
      let dat = document.getElementById('at_data').value.trim();
      if(!dat) {
        const hoje = new Date();
        dat = hoje.toISOString().slice(0,10); // yyyy-mm-dd
      }
      const diag= document.getElementById('at_diagnostico').value.trim();
      const cid = document.getElementById('at_cid').value.trim();
      const obs = document.getElementById('at_obs').value.trim();
      const anexo = document.getElementById('at_anexo').files[0];

      if(!pac || !pro){ showAlert('Preencha paciente e profissional.','warning'); return; }

      try{
        if(id){
          // PUT (sem arquivo; para remover anexo, mande remover_anexo=true)
          const res = await fetch(API, {
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
              id, paciente:pac, profissional:pro, tipo:tip, status:sta,
              data_atendimento:dat, diagnostico:diag, cid, prescricao:pres, observacoes:obs
            })
          });
          const data = await res.json();
          if(!res.ok) throw new Error(data.error || 'Falha ao atualizar');
          showAlert('Atendimento atualizado com sucesso!');
        } else {
          // POST (pode enviar arquivo)
          const fd = new FormData();
          fd.append('paciente_id', pac);
          fd.append('medico_id', pro);
          fd.append('tipo', tip);
          fd.append('status', sta);
          fd.append('data_atendimento', dat);
          fd.append('diagnostico', diag);
          fd.append('cid', cid);
          fd.append('observacoes', obs);
          if(anexo) fd.append('anexo', anexo);

          const res = await fetch(API, { method:'POST', body: fd });
          const data = await res.json();
          if(!res.ok) throw new Error(data.error || 'Falha ao salvar');
          showAlert('Atendimento salvo com sucesso!');
        }
        modal().hide();
        await loadRows();
      }catch(e){
        showAlert(e.message,'danger');
      }
    });

    // aÃ§Ãµes em linha
    tbody.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const tr = btn.closest('tr'); const id = tr.dataset.id;
      const tds = tr.querySelectorAll('td');
      const action = btn.dataset.action;

      if(action==='detalhes'){
        const labels = ['Paciente','Profissional','Tipo','Status','Data','Anexo'];
        const vals = Array.from(tds).slice(0,6).map(td=>td.innerHTML);
        document.getElementById('detailsContent').innerHTML =
          labels.map((l,i)=>`<p><strong>${l}:</strong> ${vals[i]}</p>`).join('');
        new bootstrap.Modal(document.getElementById('detailsModal')).show();
        return;
      }

      if(action==='editar'){
        document.getElementById('modalTitle').innerText = 'Editar Atendimento';
        document.getElementById('at_id').value = id;
        document.getElementById('at_paciente').value = tds[0].textContent;
        document.getElementById('at_profissional').value = tds[1].textContent;
        document.getElementById('at_tipo').value = tds[2].textContent;
        document.getElementById('at_status').value = tds[3].textContent;
        document.getElementById('at_data').value = tds[4].textContent;
        document.getElementById('at_diagnostico').value = '';
        document.getElementById('at_cid').value = '';
        document.getElementById('at_obs').value = '';
        document.getElementById('at_anexo').value = '';
        new bootstrap.Modal(modalEl).show();
        return;
      }

      if(action==='excluir'){
        if(!confirm('Deseja excluir este atendimento?')) return;
        try{
          const res = await fetch(`${API}?id=${encodeURIComponent(id)}`, { method:'DELETE' });
          const data = await res.json();
          if(!res.ok) throw new Error(data.error || 'Falha ao excluir');
          showAlert('Atendimento excluÃ­do com sucesso!');
          await loadRows();
        }catch(e){ showAlert(e.message,'danger'); }
      }
    });

    // inicializaÃ§Ã£o
    loadRows();
    loadPacientes();
    loadMedicos();
  </script>
</body>
</html>
