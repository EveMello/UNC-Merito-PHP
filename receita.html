<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Geração de Receita - Sistema de Prontuário Médico</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="css/styles.css" rel="stylesheet" />
  <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
  <style>
    .actions{display:flex;gap:.5rem}
    .card-body{padding:2rem}
    .rx-item-row{gap:.5rem;margin-bottom:1rem;padding:1rem;border:1px solid #dee2e6;border-radius:8px;background:#f8f9fa}
    .rx-item-row .form-control,.rx-item-row .form-select{min-width:120px}
    .medicamento-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
    /* Área de impressão A5/A4 */
    .print-wrap{background:#fff;border:1px solid #dee2e6;border-radius:8px;padding:24px;max-width:900px;margin:auto}
    .rx-header{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #000;padding-bottom:8px;margin-bottom:12px}
    .rx-header .clinic h4{margin:0}
    .rx-patient{border:1px dashed #999;padding:10px;margin-bottom:12px}
    .rx-items ol{padding-left:1.1rem}
    .rx-footer{display:flex;justify-content:space-between;align-items:flex-end;margin-top:24px}
    .assinatura{border-top:1px solid #000;text-align:center;padding-top:6px;min-width:260px}
    @media print{
      body{background:#fff}
      .no-print{display:none!important}
      #printArea{page-break-inside:avoid}
    }
  </style>
</head>
<body class="sb-nav-fixed">
  <!-- NAVBAR -->
  <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
    <a class="navbar-brand ps-3" href="index.html">Prontuário Médico</a>
    <button class="btn btn-link btn-sm me-4" id="sidebarToggle"><i class="fas fa-bars"></i></button>
  </nav>

  <div id="layoutSidenav">
    <!-- SIDEBAR -->
    <div id="layoutSidenav_nav">
      <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
        <div class="sb-sidenav-menu">
          <div class="nav">
            <div class="sb-sidenav-menu-heading">Principal</div>
            <a class="nav-link" href="index.html"><div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>Dashboard</a>
            <div class="sb-sidenav-menu-heading">Gestão</div>
            <a class="nav-link" href="pacientes.html"><div class="sb-nav-link-icon"><i class="fas fa-user-injured"></i></div>Pacientes</a>
            <a class="nav-link" href="medicos.html"><div class="sb-nav-link-icon"><i class="fas fa-user-md"></i></div>Médicos</a>
            <a class="nav-link" href="medicamentos.html"><div class="sb-nav-link-icon"><i class="fas fa-pills"></i></div>Medicamentos</a>
            <a class="nav-link" href="atendimentos.html"><div class="sb-nav-link-icon"><i class="fas fa-notes-medical"></i></div>Atendimentos</a>
            <!-- <a class="nav-link active" href="receita.html"><div class="sb-nav-link-icon"><i class="fas fa-file-prescription"></i></div>Receitas</a> -->
          </div>
        </div>
        <div class="sb-sidenav-footer"><div class="small">Logado como:</div>Administrador</div>
      </nav>
    </div>

    <!-- CONTEÚDO -->
    <div id="layoutSidenav_content">
      <main>
        <div class="container-fluid px-4">
          <h1 class="mt-4">Geração de Receita</h1>
          <ol class="breadcrumb mb-4">
            <li class="breadcrumb-item"><a href="index.html">Dashboard</a></li>
            <li class="breadcrumb-item active">Receitas</li>
          </ol>

          <div class="row">
            <div class="col-12 col-xl-6">
              <div class="card mb-4">
                <div class="card-header"><i class="fas fa-edit me-1"></i>Dados da Receita</div>
                <div class="card-body">
                  <div id="alertArea"></div>
                  <form id="rxForm">
                    <div class="mb-3">
                      <label class="form-label">Paciente</label>
                      <input type="text" id="paciente_nome" class="form-control" readonly>
                    </div>

                    <div class="mb-3">
                      <label class="form-label">Médico</label>
                      <input type="text" id="medico_nome" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Data de Emissão</label>
                      <input type="date" id="data_emissao" class="form-control" required>
                    </div>

                    <div class="medicamento-header">
                      <label class="form-label m-0"><strong>Medicamentos da Receita</strong></label>
                      <button type="button" class="btn btn-sm btn-outline-primary" id="addMedicamento">
                        <i class="fas fa-plus"></i> Adicionar Medicamento
                      </button>
                    </div>
                    <div id="itensWrap"></div>

                    <div class="mb-3 mt-2">
                      <label class="form-label">Observações</label>
                      <textarea id="observacoes" class="form-control" rows="2" placeholder="Ex.: Orientações gerais, alergias, etc."></textarea>
                    </div>

                    <div class="d-flex gap-2">
                      <!-- <button type="button" class="btn btn-secondary no-print" id="btnPreview">Pré-visualizar</button> -->
                      <button type="submit" class="btn btn-primary no-print" id="btnSalvar">Salvar & Imprimir</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <div class="col-12 col-xl-6">
              <div class="card mb-4">
                <div class="card-header"><i class="fas fa-file-alt me-1"></i>Pré-visualização</div>
                <div class="card-body">
                  <div id="printArea" class="print-wrap">
                    <div class="rx-header">
                      <div>
                        <h4>Mérito Health</h4>
                        <small>Rua Exemplo, 123 – Cidade/UF – Tel: (00) 0000-0000</small>
                      </div>
                      <div class="rx-id">
                        <div><strong>Receita nº</strong> <span id="rxNumero">—</span></div>
                        <div><strong>Data:</strong> <span id="rxData">—</span></div>
                      </div>
                    </div>

                    <div class="rx-patient">
                      <div><strong>Paciente:</strong> <span id="rxPaciente">—</span></div>
                      <div><strong>CPF:</strong> <span id="rxCpf">—</span></div>
                      <div><strong>Médico:</strong> <span id="rxMedico">—</span> | 
                          <strong>CRM:</strong> <span id="rxCrm">—</span></div>
                    </div>

                    <div class="rx-items">
                      <ol id="rxItens"></ol>
                    </div>

                    <div class="rx-obs">
                      <strong>Observações:</strong><br>
                      <span id="rxObs">—</span>
                    </div>

                    <div class="rx-footer">
                      <div class="assinatura">
                        Assinatura e Carimbo do Médico
                      </div>
                    </div>
                  </div>

                  <!-- <div class="mt-2 no-print d-flex gap-2">
                    <button class="btn btn-outline-secondary" onclick="window.print()"><i class="fas fa-print"></i> Imprimir</button>
                    <button class="btn btn-outline-dark" id="btnLimparPreview">Limpar Prévia</button>
                  </div> -->
                </div>
              </div>
            </div>
          </div> <!-- row -->
        </div>
      </main>

      <footer class="py-4 bg-light mt-auto">
        <div class="container-fluid px-4">
          <div class="d-flex align-items-center justify-content-between small">
            <div class="text-muted">Copyright &copy; Mérito Health</div>
          </div>
        </div>
      </footer>
    </div>
  </div>

<script>
const API = 'api/receitas.php';

let pacienteId = null;
let medicoId = null;
let atendimentoId = null;

const alertArea = document.getElementById('alertArea');
const itensWrap = document.getElementById('itensWrap');
let medicamentosData = [];

function showAlert(msg, type = 'success') {
  alertArea.innerHTML = `
    <div class="alert alert-${type} alert-dismissible fade show">
      ${msg}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  `;
}

// Carregar dados do atendimento
async function loadAtendimentoData() {
  const params = new URLSearchParams(window.location.search);
  atendimentoId = params.get('atendimento_id');

  if (!atendimentoId) {
    showAlert('Nenhum atendimento selecionado.', 'danger');
    return;
  }

  try {
    const res = await fetch(`api/atendimentos.php?id=${atendimentoId}`);
    const data = await res.json();

    if (!data) {
      showAlert('Dados do atendimento não encontrados.', 'danger');
      return;
    }

    document.getElementById('paciente_nome').value = data.paciente || '';
    document.getElementById('medico_nome').value = data.profissional || '';

    pacienteId = data.paciente_id;
    medicoId = data.medico_id;

    // Atualiza a prévia com os dados do atendimento
    document.getElementById('rxPaciente').textContent = data.paciente || '—';
    document.getElementById('rxCpf').textContent = data.cpf || '—';
    document.getElementById('rxMedico').textContent = data.profissional || '—';
    document.getElementById('rxCrm').textContent = data.crm || '—';

  } catch (e) {
    console.error(e);
    showAlert('Erro ao carregar dados do atendimento.', 'danger');
  }
}

// Monta uma linha de medicamento
function makeMedicamentoRow() {
  const row = document.createElement('div');
  row.className = 'row rx-item-row align-items-end mb-3';
  row.innerHTML = `
    <div class="col-12 d-flex justify-content-between align-items-center">
      <h6 class="m-0">Medicamento</h6>
      <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.rx-item-row').remove()">
        <i class="fas fa-trash"></i> Remover
      </button>
    </div>
    <div class="col-12 col-md-6">
      <label class="form-label">Medicamento *</label>
      <select class="form-select rx_med" required>
        <option value="">Selecione um medicamento...</option>
        ${medicamentosData.map(m => `<option value="${m.id}" data-dos="${m.dosagem || ''}">${m.nome}${m.dosagem ? ' - ' + m.dosagem : ''}</option>`).join('')}
      </select>
    </div>
    <div class="col-12 col-md-6">
      <label class="form-label">Dosagem *</label>
      <input type="text" class="form-control rx_dos" placeholder="ex: 500mg" required>
    </div>
    <div class="col-12 col-md-6 mt-2">
      <label class="form-label">Frequência *</label>
      <input type="text" class="form-control rx_freq" placeholder="ex: 8/8h, 12/12h" required>
    </div>
    <div class="col-12 col-md-6 mt-2">
      <label class="form-label">Duração</label>
      <input type="text" class="form-control rx_dur" placeholder="ex: 5 dias">
    </div>
  `;
  return row;
}

// Adicionar medicamento ao formulário
function addMedicamento() {
  itensWrap.appendChild(makeMedicamentoRow());
  updateMedicamentosPreview();
}

// Carregar medicamentos da API
async function loadMedicamentos() {
  try {
    const res = await fetch('api/receitas.php?bootstrap=1');
    const data = await res.json();
    if (!data?.medicamentos) throw new Error('Dados inválidos');

    medicamentosData = data.medicamentos;

    itensWrap.addEventListener('change', (e) => {
      if (e.target.classList.contains('rx_med')) {
        const option = e.target.selectedOptions[0];
        e.target.closest('.rx-item-row').querySelector('.rx_dos').value = option.dataset.dos || '';
      }
    });

    addMedicamento();

  } catch (err) {
    console.error(err);
    showAlert('Erro ao carregar medicamentos, usando fallback.', 'danger');
    medicamentosData = [{id:1, nome:'Medicamento Teste', dosagem:'500mg'}];
    addMedicamento();
  }
}

// Configurar data atual
function setCurrentDate() {
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  document.getElementById('data_emissao').value = `${yyyy}-${mm}-${dd}`;
  document.getElementById('rxData').textContent = `${dd}/${mm}/${yyyy}`;
}

// Validar formulário antes de salvar
function validateForm() {
  const rows = document.querySelectorAll('.rx-item-row');
  if (rows.length === 0) {
    showAlert('Adicione pelo menos um medicamento.', 'warning');
    return false;
  }
  let valid = true;
  rows.forEach(row => {
    const med = row.querySelector('.rx_med');
    const dos = row.querySelector('.rx_dos');
    const freq = row.querySelector('.rx_freq');
    if (!med.value || !dos.value || !freq.value) {
      valid = false;
      med.classList.add('is-invalid');
      dos.classList.add('is-invalid');
      freq.classList.add('is-invalid');
    }
  });
  return valid;
}

// Atualizar lista de medicamentos na pré-visualização
function updateMedicamentosPreview() {
  const rxItens = document.getElementById('rxItens');
  rxItens.innerHTML = "";
  document.querySelectorAll(".rx-item-row").forEach(row => {
    const med = row.querySelector(".rx_med");
    const dos = row.querySelector(".rx_dos");
    const freq = row.querySelector(".rx_freq");
    const dur = row.querySelector(".rx_dur");

    if (med.value) {
      const opt = med.selectedOptions[0];
      const nomeMed = opt ? opt.textContent : "";
      const item = document.createElement("li");
      item.textContent = `${nomeMed} — ${dos.value || ''}, ${freq.value || ''}${dur.value ? ', por ' + dur.value : ''}`;
      rxItens.appendChild(item);
    }
  });
}

// Atualizar pré-visualização em tempo real
function bindPreviewUpdates() {
  const pacienteNome = document.getElementById('paciente_nome');
  const medicoNome = document.getElementById('medico_nome');
  const dataEmissao = document.getElementById('data_emissao');
  const observacoes = document.getElementById('observacoes');

  const rxPaciente = document.getElementById('rxPaciente');
  const rxMedico = document.getElementById('rxMedico');
  const rxData = document.getElementById('rxData');
  const rxObs = document.getElementById('rxObs');

  // Nome paciente / médico
  pacienteNome.addEventListener('input', () => {
    rxPaciente.textContent = pacienteNome.value || '—';
  });
  medicoNome.addEventListener('input', () => {
    rxMedico.textContent = medicoNome.value || '—';
  });

  // Data
  dataEmissao.addEventListener('input', () => {
    if (dataEmissao.value) {
      const [yyyy, mm, dd] = dataEmissao.value.split("-");
      rxData.textContent = `${dd}/${mm}/${yyyy}`;
    } else {
      rxData.textContent = '—';
    }
  });

  // Observações
  observacoes.addEventListener('input', () => {
    rxObs.textContent = observacoes.value.trim() || '—';
  });

  // Ouvir mudanças nos medicamentos
  itensWrap.addEventListener("input", updateMedicamentosPreview);
  itensWrap.addEventListener("change", updateMedicamentosPreview);

  // Observer para quando adicionar/remover medicamentos
  const observer = new MutationObserver(updateMedicamentosPreview);
  observer.observe(itensWrap, { childList: true, subtree: true });

  updateMedicamentosPreview();
}

// Salvar receita
async function saveReceita(e) {
  e.preventDefault();
  if (!validateForm()) return;

  const itens = Array.from(document.querySelectorAll('.rx-item-row')).map(row => ({
    medicamento_id: parseInt(row.querySelector('.rx_med').value),
    dosagem: row.querySelector('.rx_dos').value.trim(),
    posologia: row.querySelector('.rx_freq').value.trim(),
    duracao: row.querySelector('.rx_dur').value.trim()
  }));

  const payload = {
    atendimento_id: atendimentoId,
    paciente_id: pacienteId,
    medico_id: medicoId,
    data_emissao: document.getElementById('data_emissao').value,
    observacoes: document.getElementById('observacoes')?.value.trim() || '',
    itens
  };

  console.log('Payload:', payload);

  try {
    const res = await fetch(API, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Erro ao salvar receita');

    // 🔹 Atualiza número da receita na prévia
    document.getElementById('rxNumero').textContent = data.receita_id || '—';

    showAlert('Receita salva com sucesso! Número: ' + (data.receita_id || '—'));

    // 🔹 Abre impressão SOMENTE da receita
    setTimeout(() => {
      const printContent = document.getElementById('printArea').outerHTML;
      const printWindow = window.open('', '', 'width=800,height=600');
      printWindow.document.write(`
        <html>
          <head>
            <title>Receita Médica</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
            <style>
              body { background:#fff; margin:20px; }
              .print-wrap { max-width:900px; margin:auto; }
            </style>
          </head>
          <body onload="window.print(); window.close();">
            ${printContent}
          </body>
        </html>
      `);
      printWindow.document.close();
    }, 500);

  } catch (err) {
    console.error(err);
    showAlert('Erro ao salvar receita: ' + err.message, 'danger');
  }
}


// Inicialização
document.addEventListener('DOMContentLoaded', async () => {
  document.getElementById('addMedicamento').addEventListener('click', addMedicamento);
  document.getElementById('rxForm').addEventListener('submit', saveReceita);

  await loadMedicamentos();
  await loadAtendimentoData();
  setCurrentDate();
  bindPreviewUpdates();
});
</script>



</body>
</html>